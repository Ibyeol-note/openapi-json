name: PR ìŠ¹ì¸ ì•Œë¦¼
on:
    pull_request_review:
        types: [submitted]

env:
    REQUIRED_APPROVALS: 2

jobs:
    notify_slack:
        runs-on: ubuntu-latest
        if: github.event.pull_request.merged == false

        steps:
            - name: ìŠ¹ì¸ í™•ì¸
              id: approval_check
              uses: actions/github-script@v6
              with:
                  script: |
                      const { data: reviews } = await github.rest.pulls.listReviews({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.payload.pull_request.number,
                      });

                      // ê° ë¦¬ë·°ì–´ì˜ ìµœì‹  ë¦¬ë·°ë§Œ ê³ ë ¤
                      const latestReviews = new Map();
                      reviews.forEach(review => {
                        latestReviews.set(review.user.id, review);
                      });

                      const approved_reviews = Array.from(latestReviews.values())
                        .filter(review => review.state === 'APPROVED');

                      // ìŠ¹ì¸í•œ ë¦¬ë·°ì–´ ì´ë¦„ë“¤ ìˆ˜ì§‘
                      const approvers = approved_reviews.map(review => review.user.login).join(', ');

                      core.setOutput("approved_count", approved_reviews.length);
                      core.setOutput("approvers", approvers);

            - name: Slack ì•Œë¦¼ ì „ì†¡
              if: steps.approval_check.outputs.approved_count == env.REQUIRED_APPROVALS
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
              run: |
                  RESPONSE=$(curl --max-time 10 -X POST \
                    -H 'Content-type: application/json' \
                    --data '{
                      "blocks": [
                        {
                          "type": "section",
                          "text": {
                            "type": "mrkdwn",
                            "text": ":white_check_mark: *PR ë¨¸ì§€ ì¤€ë¹„ ì™„ë£Œ!*\n<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }} ${{ github.event.pull_request.title }}>"
                          }
                        },
                        {
                          "type": "section",
                          "fields": [
                            {
                              "type": "mrkdwn",
                              "text": "*ì‘ì„±ì:*\n${{ github.event.pull_request.user.login }}"
                            },
                            {
                              "type": "mrkdwn",
                              "text": "*ìŠ¹ì¸ì:*\n${{ steps.approval_check.outputs.approvers }}"
                            }
                          ]
                        },
                        {
                          "type": "context",
                          "elements": [
                            {
                              "type": "mrkdwn",
                              "text": "í•„ìš”í•œ ìŠ¹ì¸ ìˆ˜(${{ env.REQUIRED_APPROVALS }}ê°œ)ê°€ ëª¨ë‘ ì¶©ì¡±ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ PRì„ ë¨¸ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                            }
                          ]
                        }
                      ]
                    }' \
                    -w "%{http_code}" -o /dev/null \
                    $SLACK_WEBHOOK_URL)

                  if [ "$RESPONSE" != "200" ]; then
                    echo "Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
                    exit 1
                  fi

            - name: ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„±
              if: failure()
              uses: actions/github-script@v6
              with:
                  script: |
                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'ğŸš¨ PR ìŠ¹ì¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨',
                        body: `PR #${{ github.event.pull_request.number }} ì˜ Slack ì•Œë¦¼ ì „ì†¡ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                        
                        ### ìƒì„¸ ì •ë³´
                        - PR: #${{ github.event.pull_request.number }}
                        - ì œëª©: ${{ github.event.pull_request.title }}
                        - ì‘ì„±ì: ${{ github.event.pull_request.user.login }}
                        
                        Slack ì›¹í›… ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`
                      });
